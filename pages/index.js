import Head from "next/head";
import Image from "next/image";
import styles from "../styles/Home.module.css";
import FadeIn from "react-fade-in";
import useGame from "../game/useGame";
import { maxScore } from "../game/gameReducer";

const Options = ({ options, onChooseResponse }) => {
  return (
    <ul
      style={{
        display: "flex",
        width: "100%",
        flexWrap: "wrap",
        listStyle: "none",
        justifyContent: "space-evenly",
      }}
    >
      {options.map((option, index) => (
        <li
          key={`${index}`}
          onClick={() => onChooseResponse(index)}
          className={styles.option}
        >
          {option.text}
        </li>
      ))}
    </ul>
  );
};

const Story = ({ score, maxScore }) => {
  return (
    <div
      style={{
        position: "relative",
        height: "200px",
        width: "1000px",
        backgroundColor: "gray",
      }}
    >
      <div
        style={{
          position: "absolute",
          top: "50%",
          left: "50px",
          height: "10px",
          width: "900px",
          backgroundColor: "white",
        }}
      />

      <div
        style={{
          position: "absolute",
          top: "calc(50% - (100px/2))",
          left: `calc(5px + (900px / 6) * ${Math.min(
            Math.max(0, score),
            maxScore
          )})`,
          zIndex: 10,
          opacity: score < 0 || score > maxScore ? 0.3 : 1,
        }}
      >
        <Image src="/noun-bear.svg" alt="Bear" width={100} height={100} />
      </div>

      {Array.from(Array(maxScore + 1).keys()).map((index) => (
        <div
          key={index}
          className={styles.circle}
          style={{
            left: `calc(25px + (900px / 6) * ${index})`,
          }}
        />
      ))}
    </div>
  );
};

export default function Home() {
  const [gameState, { chooseResponse, restart }] = useGame();

  const { dialogue, previousOptions, gameOver, gameWon, finalText, score } =
    gameState;

  const bearResponse = dialogue.response ?? {};
  const options = bearResponse.options ?? dialogue.options ?? previousOptions;
  const currentHumanText = dialogue.text ?? "";
  const bearText = bearResponse.text ?? "";

  const onChooseResponse = (optionIndex = 0) => {
    chooseResponse(optionIndex);
  };

  const handleRestart = () => {
    restart();
  };

  return (
    <div className={styles.container}>
      <Head>
        <title>I Will Eat You | Change My Mind</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className={styles.main}>
        <button onClick={handleRestart}>Restart</button>

        <Story score={score} maxScore={maxScore} />
        <div
          style={{
            display: "flex",
            flexDirection: "column",
            width: "1000px",

            backgroundColor: "lightblue",
            position: "relative",
            color: "black",
            justifyContent: "center",
            alignItems: "center",
          }}
        >
          {gameWon ? (
            <>
              <div>
                {finalText.split("\n").map((text, index) => (
                  <p key={`${index}-${index}`}>{text.trim()}</p>
                ))}
              </div>
              <Image
                src="/noun-grizzly-bear_stand.svg"
                height={400}
                width={400}
                alt="Bear"
              />
              <big>{`I think I might go try to get some food. 

                You can go home now.`}</big>
            </>
          ) : gameOver ? (
            <>
              <div>
                {finalText.split("\n").map((text, index) => (
                  <p key={`${index}-${index}`}>{text.trim()}</p>
                ))}
              </div>
              <Image
                src="/noun-bear_scare.svg"
                height={400}
                width={400}
                alt="Attacking bear"
              />
              <big>*eats you*</big>
            </>
          ) : (
            <>
              <div
                style={{
                  // position: "absolute",
                  height: "500px",
                  width: "1000px",
                  backgroundColor: "pink",
                }}
              >
                <div>
                  <FadeIn>
                    {currentHumanText.split("\n").map((text, index) => (
                      <p key={`${index}-${index}`}>{text.trim()}</p>
                    ))}
                  </FadeIn>
                </div>

                <div style={{ backgroundColor: "cornflowerblue" }}>
                  <FadeIn>
                    {bearText.split("\n").map((text, index) => (
                      <p key={`${index}-${index}`}>{text}</p>
                    ))}
                  </FadeIn>
                </div>

                <Options
                  options={options}
                  onChooseResponse={onChooseResponse}
                />
              </div>
            </>
          )}
        </div>
      </main>

      <footer className={styles.footer}></footer>
    </div>
  );
}
